# Goss test file for OroDC installation verification
# This file tests that all OroDC components are properly installed and running

# Test Docker containers are running
process:
  # We test for docker processes since we're testing from outside containers
  docker:
    running: true

# Test that required ports are accessible
port:
  # HTTP (nginx) - will be dynamically detected
  "80":
    listening: true
    ip:
      - 127.0.0.1
  
  # PostgreSQL
  "5432": 
    listening: true
    ip:
      - 127.0.0.1
  
  # RabbitMQ Management
  "15672":
    listening: true  
    ip:
      - 127.0.0.1
    
  # Elasticsearch  
  "9200":
    listening: true
    ip:
      - 127.0.0.1

# Test HTTP endpoints
http:
  # Main application page
  "http://localhost:HTTP_PORT":
    status: 200
    timeout: 30000
    headers:
      Content-Type: "text/html"
    body:
      - "<!DOCTYPE html"
    
  # Admin login page  
  "http://localhost:HTTP_PORT/admin":
    status: 200
    timeout: 30000
    headers:
      Content-Type: "text/html"
    body:
      - "login"
      - "password"

# Test key service endpoints
  "http://localhost:HTTP_PORT/api":
    status: 200
    timeout: 10000

  # Elasticsearch health
  "http://localhost:ES_PORT":
    status: 200  
    timeout: 10000
    
  # RabbitMQ management 
  "http://localhost:RABBITMQ_PORT":
    status: 200
    timeout: 10000

# Command tests (to be run inside OroDC environment)
command:
  # Test PHP version
  "orodc php --version":
    exit-status: 0
    stdout:
      - "PHP 8."
    timeout: 10000
    
  # Test database connection  
  "orodc psql -c 'SELECT version()'":
    exit-status: 0
    stdout:
      - "PostgreSQL"
    timeout: 10000
    
  # Test Symfony console is working
  "orodc bin/console --version":
    exit-status: 0
    stdout: 
      - "Symfony"
    timeout: 10000

  # Test that required containers are running
  "docker ps --filter 'name=PROJECT_NAME' --format '{{.Status}}' | grep -c Up":
    exit-status: 0
    stdout:
      - "/^[6-9]/"  # At least 6 containers should be Up
    timeout: 5000
