user www-data www-data;
worker_processes auto;
worker_rlimit_nofile 16384;

error_log /dev/stdout info;

events {
    worker_connections 1024;
}

http {
    include          mime.types;
    default_type     application/octet-stream;
    set_real_ip_from 0.0.0.0/0;
    
    # Allow headers with underscores (e.g., HTTP_X_FORWARDED_PROTO from Traefik)
    underscores_in_headers on;
    
    # Don't ignore invalid headers from upstream (Traefik)
    ignore_invalid_headers off;

    # Gzip compression
    gzip on;
    gzip_proxied any;
    gzip_types text/plain text/xml text/css application/javascript application/json image/svg+xml application/ttf application/x-ttf application/x-font-ttf font/opentype font/x-woff font/ttf;
    gzip_vary on;
    gzip_comp_level 1;

    # Timeouts
    proxy_connect_timeout       300;
    proxy_send_timeout          300;
    proxy_read_timeout          300;
    send_timeout                300;

    # Client body size for uploads
    client_max_body_size 256m;

    # JSON access log format
    log_format access_json '{'
        '"remote_addr": "$remote_addr", '
        '"time_local": "$time_local", '
        '"status": "$status", '
        '"request": "$request", '
        '"document_root": "$document_root", '
        '"request_time": "$request_time", '
        '"upstream_response_time": "$upstream_response_time"'
    '}';

    access_log /dev/stdout access_json;

    server {
        listen 127.0.0.1:81;
        server_name _;

        # Base app directory (replaced by entrypoint)
        set $app_root /var/www;
        
        # ===========================================
        # RUNTIME DOCUMENT ROOT DETECTION
        # Priority order (last matching wins):
        # 1. public/ (Symfony 3+/Laravel/Oro) - highest
        # 2. web/ (Symfony 2.x legacy)
        # 3. pub/ (Magento 2)
        # 4. root (fallback)
        # ===========================================
        
        set $doc_root $app_root;
        
        # Check pub/ (Magento 2) - lowest priority
        if (-d $app_root/pub) {
            set $doc_root $app_root/pub;
        }
        
        # Check web/ (Symfony 2.x legacy)
        if (-d $app_root/web) {
            set $doc_root $app_root/web;
        }
        
        # Check public/ (Symfony 3+/Laravel/Oro) - highest priority
        if (-d $app_root/public) {
            set $doc_root $app_root/public;
        }

        # ===========================================
        # CMS TYPE DETECTION
        # ===========================================
        set $project_type "default";

        # Symfony-like projects (Oro/Symfony) are detected by bin/console
        if (-f $app_root/bin/console) {
            set $project_type "symfony_like";
        }

        # Magento 2 is detected by bin/magento
        if (-f $app_root/bin/magento) {
            set $project_type "magento2";
        }

        root $doc_root;
        index app.php index.php index.html index.htm;

        # Front controller: prefer app.php for legacy Symfony/Oro apps
        set $cgi_index /index.php;
        if (-f $doc_root/app.php) {
            set $cgi_index /app.php;
        }

        charset UTF-8;

        # ===========================================
        # SECURITY: Deny access to sensitive files
        # ===========================================
        
        # Hidden files
        location ~ /\. {
            log_not_found off;
            deny all;
        }

        # Sensitive files
        location ~* (composer\.(json|lock)|package\.json|yarn\.lock|\.env|\.git|Makefile|phpunit|behat) {
            deny all;
        }

        # ===========================================
        # UNIVERSAL ROUTING (works for all frameworks)
        # ===========================================

        location /minify/ {
            rewrite ^/minify/([^/]+)(/.*.(js|css))$ /lib/minify/m.php?f=$2&d=$1 last;
        }

        location /skin/m/ {
            rewrite ^/skin/m/([^/]+)(/.*.(js|css))$ /lib/minify/m.php?f=$2&d=$1 last;
        }
        
        location / {
            # Try file, then directory, then index.php with query string
            # Works for: Symfony, Laravel, Oro, generic PHP
            try_files $uri $uri/ @handler;
        }

        # Common front handler
        location @handler {
            rewrite / $cgi_index;
        }

        # ===========================================
        # STATIC ASSETS WITH CACHING
        # ===========================================
        
        # Common asset directories (Symfony/Oro/Laravel/Generic)
        location ~* ^/(bundles|js|css|dist|cache|build|assets|vendor|storage)/ {
            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2|html|json|map)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri $cgi_index$is_args$args;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri $cgi_index$is_args$args;
            }

            add_header X-Frame-Options "SAMEORIGIN";
            try_files $uri $cgi_index$is_args$args;
        }

        # ===========================================
        # CMS SPECIFIC PATHS
        # ===========================================
        
        # Magento 2 static files (versioned)
        location ^~ /static/ {
            set $static_fallback $cgi_index$is_args$args;

            if ($project_type = "magento2") {
                set $static_fallback /static.php?resource=$uri;
                rewrite ^/static/version\d*/(.*)$ /static/$1 last;
            }

            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2|html|json)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri $static_fallback;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri $static_fallback;
            }

            try_files $uri $static_fallback;
            add_header X-Frame-Options "SAMEORIGIN";
        }

        # Media files
        location ^~ /media/ {
            set $project_type_flag $project_type;
            set $media_fallback /__orodc_media_next__;

            if (!-f $request_filename) {
                set $project_type_flag $project_type"_nofile";
            }

            if ($project_type = "magento2") {
                set $media_fallback /get.php$is_args$args;
            }

            if ($project_type = "symfony_like") {
                set $media_fallback /__orodc_media_next__;
            }

            if ($project_type_flag = "magento2_nofile") {
                set $media_fallback /get.php$is_args$args;
            }

            if ($project_type_flag = "symfony_like_nofile") {
                set $media_fallback $cgi_index$is_args$args;
            }

            location ~ ^/media/theme_customization/.*\.xml {
                deny all;
            }

            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri $uri/ $media_fallback;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri $uri/ $media_fallback;
            }

            try_files $uri $uri/ $media_fallback;
            add_header X-Frame-Options "SAMEORIGIN";
        }

        location = /__orodc_media_next__ {
            internal;
            return 404;
        }

        # ===========================================
        # PHP-FPM PROCESSING
        # ===========================================
        
        # Set HTTPS parameter for FastCGI based on actual HTTPS status or X-Forwarded-Proto header
        # This ensures Symfony/Oro correctly detects HTTPS when behind reverse proxy (Traefik)
        set $fcgi_https off;
        
        # Check if nginx itself is serving HTTPS
        if ($https = on) {
            set $fcgi_https on;
        }
        
        # Check if request came via HTTPS through reverse proxy (Traefik sets this header)
        if ($http_x_forwarded_proto = "https") {
            set $fcgi_https on;
        }

        # Forward paths like /js/index.php/x.js to relevant handler
        location ~ \.php/ {
            rewrite ^(.*.php)/ $1 last;
        }

        # Process PHP files
        location ~ \.php$ {
            try_files $uri =404;

            fastcgi_pass            fpm:9000;
            fastcgi_buffers         32 16k;
            fastcgi_buffer_size     32k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;

            fastcgi_read_timeout    300s;
            fastcgi_connect_timeout 300s;
            fastcgi_send_timeout    300s;

            fastcgi_split_path_info ^(.+\.php)(/.*)$;
            fastcgi_index           index.php;
            include                 fastcgi_params;

            fastcgi_param           SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param           PATH_INFO $fastcgi_path_info;
            fastcgi_param           HTTPS $fcgi_https;
            fastcgi_param           SERVER_NAME $host;
            fastcgi_param           REMOTE_ADDR "127.0.0.1";
            
            # Pass X-Forwarded-* headers from Traefik to PHP-FPM
            # This is critical for Symfony/Oro to correctly detect HTTPS behind reverse proxy
            fastcgi_param           HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
            fastcgi_param           HTTP_X_FORWARDED_FOR $http_x_forwarded_for;
            fastcgi_param           HTTP_X_FORWARDED_HOST $http_x_forwarded_host;
            fastcgi_param           HTTP_X_FORWARDED_PORT $http_x_forwarded_port;
            
            # XHGui profiling params (Oro/Symfony)
            fastcgi_param           XHGUI_MONGO_HOSTNAME mongodb;
            fastcgi_param           XHGUI_MONGO_PORT 27017;
            fastcgi_param           XHGUI_MONGO_DATABASE xhprof;

            # Magento 2 developer mode
            fastcgi_param           MAGE_IS_DEVELOPER_MODE true;

            # Disable output buffering for streaming
            fastcgi_buffering       off;
            
            add_header Cache-Control "no-store";
            expires off;
        }

        # ===========================================
        # WEBSOCKET SUPPORT (Oro Platform)
        # ===========================================
        location /ws {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-NginX-Proxy true;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://websocket:8080/$is_args$args;
            proxy_redirect off;
            proxy_read_timeout 86400;

            # WebSocket upgrade
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Prevent 502 bad gateway
            proxy_buffers 8 32k;
            proxy_buffer_size 64k;

            reset_timedout_connection on;

            # Graceful error handling if websocket service not running
            proxy_intercept_errors on;
            error_page 502 503 504 = @websocket_fallback;
        }

        location @websocket_fallback {
            return 503 "WebSocket service not available";
        }

        # ===========================================
        # LARAVEL SPECIFIC ROUTES
        # ===========================================
        location /horizon {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /telescope {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /storage {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # ===========================================
        # HEALTH CHECK
        # ===========================================
        location /nginx-health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }

    # ===========================================
    # PUBLIC FACING SERVER (port 80)
    # ===========================================
    server {
        listen 0.0.0.0:80;
        server_name _;

        location / {
            proxy_pass http://127.0.0.1:81;
            proxy_pass_request_headers on;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # CRITICAL: Pass original X-Forwarded-Proto from Traefik, not current $scheme
            # If no X-Forwarded-Proto header exists, use current $scheme
            proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
            # Also pass other X-Forwarded-* headers from Traefik
            proxy_set_header X-Forwarded-Host $http_x_forwarded_host;
            proxy_set_header X-Forwarded-Port $http_x_forwarded_port;

            proxy_connect_timeout   300s;
            proxy_send_timeout      300s;
            proxy_read_timeout      300s;
            send_timeout            300s;
        }
    }
}
