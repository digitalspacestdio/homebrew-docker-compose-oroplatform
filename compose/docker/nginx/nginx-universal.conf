user www-data www-data;
worker_processes auto;
worker_rlimit_nofile 16384;

error_log /dev/stdout info;

events {
    worker_connections 1024;
}

http {
    include          mime.types;
    default_type     application/octet-stream;
    set_real_ip_from 0.0.0.0/0;

    # Gzip compression
    gzip on;
    gzip_proxied any;
    gzip_types text/plain text/xml text/css application/javascript application/json image/svg+xml application/ttf application/x-ttf application/x-font-ttf font/opentype font/x-woff font/ttf;
    gzip_vary on;
    gzip_comp_level 1;

    # Timeouts
    proxy_connect_timeout       300;
    proxy_send_timeout          300;
    proxy_read_timeout          300;
    send_timeout                300;

    # Client body size for uploads
    client_max_body_size 256m;

    # JSON access log format
    log_format access_json '{'
        '"remote_addr": "$remote_addr", '
        '"time_local": "$time_local", '
        '"status": "$status", '
        '"request": "$request", '
        '"document_root": "$document_root", '
        '"request_time": "$request_time", '
        '"upstream_response_time": "$upstream_response_time"'
    '}';

    access_log /dev/stdout access_json;

    server {
        listen 127.0.0.1:81;
        server_name _;

        # Base app directory (replaced by entrypoint)
        set $app_root /var/www;
        
        # ===========================================
        # RUNTIME DOCUMENT ROOT DETECTION
        # Priority order (last matching wins):
        # 1. public/ (Symfony 3+/Laravel/Oro) - highest
        # 2. web/ (Symfony 2.x legacy)
        # 3. pub/ (Magento 2)
        # 4. root (fallback)
        # ===========================================
        
        set $doc_root $app_root;
        
        # Check pub/ (Magento 2) - lowest priority
        if (-d $app_root/pub) {
            set $doc_root $app_root/pub;
        }
        
        # Check web/ (Symfony 2.x legacy)
        if (-d $app_root/web) {
            set $doc_root $app_root/web;
        }
        
        # Check public/ (Symfony 3+/Laravel/Oro) - highest priority
        if (-d $app_root/public) {
            set $doc_root $app_root/public;
        }

        root $doc_root;
        index index.php index.html index.htm;

        charset UTF-8;

        # ===========================================
        # SECURITY: Deny access to sensitive files
        # ===========================================
        
        # Hidden files
        location ~ /\. {
            log_not_found off;
            deny all;
        }

        # Sensitive files
        location ~* (composer\.(json|lock)|package\.json|yarn\.lock|\.env|\.git|Makefile|phpunit|behat) {
            deny all;
        }

        # ===========================================
        # UNIVERSAL ROUTING (works for all frameworks)
        # ===========================================
        
        location / {
            # Try file, then directory, then index.php with query string
            # Works for: Symfony, Laravel, Oro, generic PHP
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # ===========================================
        # STATIC ASSETS WITH CACHING
        # ===========================================
        
        # Common asset directories (Symfony/Oro/Laravel/Generic)
        location ~* ^/(bundles|js|css|dist|cache|build|assets|vendor|storage)/ {
            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2|html|json|map)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri /index.php$is_args$args;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri /index.php$is_args$args;
            }

            add_header X-Frame-Options "SAMEORIGIN";
            try_files $uri /index.php$is_args$args;
        }

        # ===========================================
        # MAGENTO 2 SPECIFIC PATHS
        # ===========================================
        
        # Magento 2 static files (versioned)
        location /static/ {
            location ~ ^/static/version\d*/ {
                rewrite ^/static/version\d*/(.*)$ /static/$1 last;
            }

            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2|html|json)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri /static.php?resource=$uri;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri /static.php?resource=$uri;
            }

            try_files $uri /static.php?resource=$uri;
            add_header X-Frame-Options "SAMEORIGIN";
        }

        # Magento 2 media files
        location /media/ {
            location ~ ^/media/theme_customization/.*\.xml {
                deny all;
            }

            location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|js|css|swf|eot|ttf|otf|woff|woff2)$ {
                add_header Cache-Control "public";
                add_header X-Frame-Options "SAMEORIGIN";
                expires +1y;
                try_files $uri $uri/ /get.php$is_args$args;
            }

            location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                add_header Cache-Control "no-store";
                add_header X-Frame-Options "SAMEORIGIN";
                expires off;
                try_files $uri $uri/ /get.php$is_args$args;
            }

            try_files $uri $uri/ /get.php$is_args$args;
            add_header X-Frame-Options "SAMEORIGIN";
        }

        # ===========================================
        # PHP-FPM PROCESSING
        # ===========================================
        
        set $fcgi_https $https;

        if ($http_x_forwarded_proto = "https") {
            set $fcgi_https on;
        }

        # Forward paths like /js/index.php/x.js to relevant handler
        location ~ \.php/ {
            rewrite ^(.*.php)/ $1 last;
        }

        # Process PHP files
        location ~ \.php$ {
            try_files $uri =404;

            fastcgi_pass            fpm:9000;
            fastcgi_buffers         32 16k;
            fastcgi_buffer_size     32k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;

            fastcgi_read_timeout    300s;
            fastcgi_connect_timeout 300s;
            fastcgi_send_timeout    300s;

            fastcgi_split_path_info ^(.+\.php)(/.*)$;
            fastcgi_index           index.php;
            include                 fastcgi_params;

            fastcgi_param           SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param           PATH_INFO $fastcgi_path_info;
            fastcgi_param           HTTPS $fcgi_https;
            fastcgi_param           SERVER_NAME $host;
            fastcgi_param           REMOTE_ADDR "127.0.0.1";
            
            # XHGui profiling params (Oro/Symfony)
            fastcgi_param           XHGUI_MONGO_HOSTNAME mongodb;
            fastcgi_param           XHGUI_MONGO_PORT 27017;
            fastcgi_param           XHGUI_MONGO_DATABASE xhprof;

            # Magento 2 developer mode
            fastcgi_param           MAGE_IS_DEVELOPER_MODE true;

            # Disable output buffering for streaming
            fastcgi_buffering       off;
            
            add_header Cache-Control "no-store";
            expires off;
        }

        # ===========================================
        # WEBSOCKET SUPPORT (Oro Platform)
        # ===========================================
        location /ws {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-NginX-Proxy true;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_pass http://websocket:8080/$is_args$args;
            proxy_redirect off;
            proxy_read_timeout 86400;

            # WebSocket upgrade
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Prevent 502 bad gateway
            proxy_buffers 8 32k;
            proxy_buffer_size 64k;

            reset_timedout_connection on;

            # Graceful error handling if websocket service not running
            proxy_intercept_errors on;
            error_page 502 503 504 = @websocket_fallback;
        }

        location @websocket_fallback {
            return 503 "WebSocket service not available";
        }

        # ===========================================
        # LARAVEL SPECIFIC ROUTES
        # ===========================================
        location /horizon {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /telescope {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /storage {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        # ===========================================
        # HEALTH CHECK
        # ===========================================
        location /nginx-health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }

    # ===========================================
    # PUBLIC FACING SERVER (port 80)
    # ===========================================
    server {
        listen 0.0.0.0:80;
        server_name _;

        location / {
            proxy_pass http://127.0.0.1:81;
            proxy_pass_request_headers on;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout   300s;
            proxy_send_timeout      300s;
            proxy_read_timeout      300s;
            send_timeout            300s;
        }
    }
}
