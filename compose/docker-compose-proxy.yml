services:
  proxy:
    hostname: proxy.docker.local
    build:
      context: ./docker/proxy
      args:
        TARGETARCH: ${TARGETARCH:-amd64}
    container_name: proxy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    ports:
      - "${TRAEFIK_BIND_ADDRESS:-127.0.0.1}:${TRAEFIK_BIND_PORT:-8880}:80"
      - "${TRAEFIK_BIND_ADDRESS:-127.0.0.1}:${TRAEFIK_HTTPS_BIND_PORT:-8443}:443"
      - "${TRAEFIK_BIND_ADDRESS:-127.0.0.1}:${DC_PROXY_SOCKS5_PORT:-1080}:1080"
    networks:
      - "dc_shared_net"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "proxy_certs:/certs"
    environment:
      - TRAEFIK_LOG_LEVEL=${TRAEFIK_LOG_LEVEL:-INFO}
      - CERT_DOMAIN=${CERT_DOMAIN:-docker.local}
      - DC_PROXY_SOCKS5_ENABLED=${DC_PROXY_SOCKS5_ENABLED:-1}
      - DC_PROXY_SOCKS5_PORT=${DC_PROXY_SOCKS5_PORT:-1080}
      - DC_PROXY_DNS_SYNC_ENABLED=${DC_PROXY_DNS_SYNC_ENABLED:-1}
      - SOCKS_ADDR=0.0.0.0:${DC_PROXY_SOCKS5_PORT:-1080}
      - REQUIRE_AUTH=false
    labels:
      # Traefik routing
      traefik.enable: 'true'
      
      # Dashboard access via PathPrefix (for localhost:8880/traefik/dashboard)
      traefik.http.routers.traefik-api-path.rule: 'PathPrefix(`/traefik/dashboard`) || PathPrefix(`/api`)'
      traefik.http.routers.traefik-api-path.priority: 8000
      traefik.http.routers.traefik-api-path.entrypoints: "web"
      traefik.http.routers.traefik-api-path.service: "api@internal"
      traefik.http.routers.traefik-api-path.middlewares: "traefik-api-stripprefix"
      traefik.http.middlewares.traefik-api-stripprefix.stripprefix.prefixes: "/traefik"
      
      # Dashboard access via Host (for proxy.docker.local and traefik.docker.local via SOCKS5)
      traefik.http.routers.traefik-api-host.rule: 'Host(`proxy.docker.local`) || Host(`traefik.docker.local`)'
      traefik.http.routers.traefik-api-host.priority: 9000
      traefik.http.routers.traefik-api-host.entrypoints: "web"
      traefik.http.routers.traefik-api-host.service: "api@internal"
      
      # Default entrypoint versions (TLS is terminated by proxy entrypoint)
      traefik.http.routers.traefik-api-path-default.rule: 'PathPrefix(`/traefik/dashboard`) || PathPrefix(`/api`)'
      traefik.http.routers.traefik-api-path-default.priority: 8000
      traefik.http.routers.traefik-api-path-default.entrypoints: "default"
      traefik.http.routers.traefik-api-path-default.service: "api@internal"
      traefik.http.routers.traefik-api-path-default.middlewares: "traefik-api-stripprefix"
      
      traefik.http.routers.traefik-api-host-default.rule: 'Host(`proxy.docker.local`) || Host(`traefik.docker.local`)'
      traefik.http.routers.traefik-api-host-default.priority: 9000
      traefik.http.routers.traefik-api-host-default.entrypoints: "default"
      traefik.http.routers.traefik-api-host-default.service: "api@internal"
      
      # DNS sync (auto-updates /etc/hosts inside proxy container)
      orodc.dns.hostname: 'proxy.docker.local,traefik.docker.local'
    healthcheck:
      test: traefik healthcheck --ping
      start_period: 5s
      interval: 5s
      retries: 30

volumes:
  proxy_certs:
    name: proxy_certs

networks:
  dc_shared_net:
    name: dc_shared_net
    external: true
