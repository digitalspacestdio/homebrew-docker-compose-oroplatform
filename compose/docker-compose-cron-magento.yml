# Magento Cron Service (Ofelia)
# Included only for Magento projects (magento CMS type)
# Runs bin/magento cron:run every minute using Ofelia binary inside cron container
# Cron container is based on our PHP image, so it has PHP and project code
services:
  cron:
    container_name: "${DC_ORO_NAME:-unnamed}_cron"
    hostname: cron.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    build:
      dockerfile: Dockerfile.project
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/project-php-node-symfony"
      args:
        BASE_IMAGE: "ghcr.io/digitalspacestdio/orodc-php-node-symfony:${DC_ORO_PHP_VERSION:-8.4}-node${DC_ORO_NODE_VERSION:-22}-composer${DC_ORO_COMPOSER_VERSION:-2}-${DC_ORO_PHP_DIST:-alpine}"
        APP_DIR: "${DC_ORO_APPDIR:-/var/www}"
        PHP_VERSION: "${DC_ORO_PHP_VERSION:-8.4}"
        NODE_VERSION: "${DC_ORO_NODE_VERSION:-22}"
        PHP_USER_NAME: "${DC_ORO_PHP_USER_NAME:-developer}"
        PHP_USER_GROUP: "${DC_ORO_PHP_USER_GROUP:-developer}"
        PHP_UID: "${DC_ORO_PHP_UID:-1000}"
        PHP_GID: "${DC_ORO_PHP_GID:-1000}"
        COMPOSER_VERSION: "${DC_ORO_COMPOSER_VERSION:-2}"
    user: "${DC_ORO_USER_NAME:-developer}"
    command: /usr/bin/ofelia daemon --docker
    volumes:
      - "appcode:${DC_ORO_APPDIR:-/var/www}:consistent"
      - "home-user:/home/${DC_ORO_PHP_USER_NAME:-developer}"
      - "home-root:/root"
      - "mail-certs:/certs:ro"
      - /var/run/docker.sock:/var/run/docker.sock:ro
    working_dir: "${DC_ORO_APPDIR:-/var/www}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - 'APP_DIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_APPDIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DOCKER_BASE_URL=${DOCKER_BASE_URL:-https://${DC_ORO_NAME:-unnamed}.docker.local}'
      - 'DC_ORO_DATABASE_HOST=${DC_ORO_DATABASE_HOST:-database}'
    labels:
      # Execute Magento cron every minute inside cron container (job-run mode)
      # Cron container has PHP and project code, so commands run locally
      ofelia.job-run.magento-cron.schedule: "* * * * *"
      ofelia.job-run.magento-cron.command: "php bin/magento cron:run"
      ofelia.job-run.magento-cron.user: "${DC_ORO_USER_NAME:-developer}"
      ofelia.job-run.magento-cron.no-overlap: "true"
    depends_on:
      fpm:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
