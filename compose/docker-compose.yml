services:
  database:
    image: 'busybox'
    container_name: ${DC_ORO_NAME:-unnamed}_database
    hostname: database.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    command: sleep infinity
    restart: always
    deploy:
      resources:
        limits:
          memory: 7G
    healthcheck:
      test: "sh -c 'exit 0'"
  fpm:
    container_name: "${DC_ORO_NAME:-unnamed}_fpm_${DC_ORO_PHP_VERSION:-8.4}-${DC_ORO_NODE_VERSION:-22}-${DC_ORO_COMPOSER_VERSION:-2}"
    hostname: fpm.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    build:
      dockerfile: Dockerfile.project
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/project-php-node-symfony"
      args:
        BASE_IMAGE: "ghcr.io/digitalspacestdio/orodc-php-node-symfony:${DC_ORO_PHP_VERSION:-8.4}-node${DC_ORO_NODE_VERSION:-22}-composer${DC_ORO_COMPOSER_VERSION:-2}-${DC_ORO_PHP_DIST:-alpine}"
        APP_DIR: "${DC_ORO_APPDIR:-/var/www}"
        PHP_VERSION: "${DC_ORO_PHP_VERSION:-8.4}"
        NODE_VERSION: "${DC_ORO_NODE_VERSION:-22}"
        PHP_USER_NAME: "${DC_ORO_PHP_USER_NAME:-developer}"
        PHP_USER_GROUP: "${DC_ORO_PHP_USER_GROUP:-developer}"
        PHP_UID: "${DC_ORO_PHP_UID:-1000}"
        PHP_GID: "${DC_ORO_PHP_GID:-1000}"
        COMPOSER_VERSION: "${DC_ORO_COMPOSER_VERSION:-2}"
    user: "${DC_ORO_USER_NAME:-developer}"
    command: php-fpm -R
    volumes:
      - "appcode:${DC_ORO_APPDIR:-/var/www}:consistent"
      - "home-user:/home/${DC_ORO_PHP_USER_NAME:-developer}"
      - "home-root:/root"
      - "mail-certs:/certs:ro"
    working_dir: "${DC_ORO_APPDIR:-/var/www}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - 'APP_DIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_APPDIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DOCKER_BASE_URL=${DOCKER_BASE_URL:-https://${DC_ORO_NAME:-unnamed}.docker.local}'
      - 'DC_ORO_DATABASE_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'DC_ORO_DATABASE_PORT=${DC_ORO_DATABASE_PORT:-3306}'
      - 'DC_ORO_DATABASE_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'DC_ORO_DATABASE_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'DC_ORO_DATABASE_DBNAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_URL=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_DSN=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'ORO_DB_PORT=${DC_ORO_DATABASE_PORT:-5432}'
      - 'ORO_DB_NAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'ORO_DB_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'ORO_SEARCH_URL=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_search'
      - 'ORO_WEBSITE_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_website_search'
      - 'ORO_MQ_DSN=${DC_ORO_MQ_URI:-""}'
      - 'ORO_REDIS_URL=${DC_ORO_REDIS_URI:-""}'
      - 'ORO_SESSION_DSN=${DC_ORO_REDIS_URI:-""}/0'
      - 'ORO_REDIS_CACHE_DSN=${DC_ORO_REDIS_URI:-""}/1'
      - 'ORO_REDIS_DOCTRINE_DSN=${DC_ORO_REDIS_URI:-""}/2'
      - 'ORO_REDIS_LAYOUT_DSN=${DC_ORO_REDIS_URI:-""}/3'
      - 'ORO_MAILER_DRIVER=${ORO_MAILER_DRIVER:-smtp}'
      - 'ORO_MAILER_HOST=${ORO_MAILER_HOST:-mail}'
      - 'ORO_MAILER_PORT=${ORO_MAILER_PORT:-1025}'
      - 'ORO_MAILER_ENCRYPTION=${ORO_MAILER_ENCRYPTION:-starttls}'
      - 'ORO_MAILER_USER=${ORO_MAILER_USER:-}'
      - 'ORO_MAILER_PASSWORD=${ORO_MAILER_PASSWORD:-}'
      - 'ORO_SECRET=${ORO_SECRET-ThisTokenIsNotSoSecretChangeIt}'
      - 'ORO_ENABLE_PRICE_SHARDING=${ORO_ENABLE_PRICE_SHARDING:-0}'
      - 'XHGUI_MONGO_HOSTNAME=mongodb'
      - 'XHGUI_MONGO_DATABASE=xhprof'
      - 'COMPOSER_AUTH=${DC_ORO_COMPOSER_AUTH}'
      - 'NODE_OPTIONS="--max-old-space-size=1024"'
      - 'SYMFONY_ENV=${SYMFONY_ENV:-dev}'
      - 'XDEBUG_MODE=${XDEBUG_MODE_FPM:-off}'
    depends_on:
      database:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 7G
    healthcheck:
      test: /bin/bash -c "</dev/tcp/localhost/9000"
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  cli:
    container_name: "${DC_ORO_NAME:-unnamed}_cli_${DC_ORO_PHP_VERSION:-8.4}-${DC_ORO_NODE_VERSION:-22}-${DC_ORO_COMPOSER_VERSION:-2}"
    hostname: cli.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    build:
      dockerfile: Dockerfile.project
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/project-php-node-symfony"
      args:
        BASE_IMAGE: "ghcr.io/digitalspacestdio/orodc-php-node-symfony:${DC_ORO_PHP_VERSION:-8.4}-node${DC_ORO_NODE_VERSION:-22}-composer${DC_ORO_COMPOSER_VERSION:-2}-${DC_ORO_PHP_DIST:-alpine}"
        APP_DIR: "${DC_ORO_APPDIR:-/var/www}"
        PHP_VERSION: "${DC_ORO_PHP_VERSION:-8.4}"
        NODE_VERSION: "${DC_ORO_NODE_VERSION:-22}"
        PHP_USER_NAME: "${DC_ORO_PHP_USER_NAME:-developer}"
        PHP_USER_GROUP: "${DC_ORO_PHP_USER_GROUP:-developer}"
        PHP_UID: "${DC_ORO_PHP_UID:-1000}"
        PHP_GID: "${DC_ORO_PHP_GID:-1000}"
        COMPOSER_VERSION: "${DC_ORO_COMPOSER_VERSION:-2}"
    user: "${DC_ORO_USER_NAME:-developer}"
    volumes:
      - "appcode:${DC_ORO_APPDIR:-/var/www}:consistent"
      - "home-user:/home/${DC_ORO_PHP_USER_NAME:-developer}"
      - "home-root:/root"
      - "mail-certs:/certs:ro"
    working_dir: "${DC_ORO_APPDIR:-/var/www}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - 'APP_DIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_APPDIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DOCKER_BASE_URL=${DOCKER_BASE_URL:-https://${DC_ORO_NAME:-unnamed}.docker.local}'
      - 'DC_ORO_DATABASE_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'DC_ORO_DATABASE_PORT=${DC_ORO_DATABASE_PORT:-3306}'
      - 'DC_ORO_DATABASE_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'DC_ORO_DATABASE_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'DC_ORO_DATABASE_DBNAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_URL=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_DSN=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'ORO_DB_PORT=${DC_ORO_DATABASE_PORT:-5432}'
      - 'ORO_DB_NAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'ORO_DB_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'ORO_SEARCH_URL=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_search'
      - 'ORO_WEBSITE_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_website_search'
      - 'ORO_MQ_DSN=${DC_ORO_MQ_URI:-""}'
      - 'ORO_REDIS_URL=${DC_ORO_REDIS_URI:-""}'
      - 'ORO_SESSION_DSN=${DC_ORO_REDIS_URI:-""}/0'
      - 'ORO_REDIS_CACHE_DSN=${DC_ORO_REDIS_URI:-""}/1'
      - 'ORO_REDIS_DOCTRINE_DSN=${DC_ORO_REDIS_URI:-""}/2'
      - 'ORO_REDIS_LAYOUT_DSN=${DC_ORO_REDIS_URI:-""}/3'
      - 'ORO_MAILER_DRIVER=${ORO_MAILER_DRIVER:-smtp}'
      - 'ORO_MAILER_HOST=${ORO_MAILER_HOST:-mail}'
      - 'ORO_MAILER_PORT=${ORO_MAILER_PORT:-1025}'
      - 'ORO_MAILER_ENCRYPTION=${ORO_MAILER_ENCRYPTION:-starttls}'
      - 'ORO_MAILER_USER=${ORO_MAILER_USER:-}'
      - 'ORO_MAILER_PASSWORD=${ORO_MAILER_PASSWORD:-}'
      - 'ORO_SECRET=${ORO_SECRET-ThisTokenIsNotSoSecretChangeIt}'
      - 'ORO_ENABLE_PRICE_SHARDING=${ORO_ENABLE_PRICE_SHARDING:-0}'
      - 'XHGUI_MONGO_HOSTNAME=mongodb'
      - 'XHGUI_MONGO_DATABASE=xhprof'
      - 'COMPOSER_AUTH=${DC_ORO_COMPOSER_AUTH}'
      - 'NODE_OPTIONS="--max-old-space-size=1024"'
      - 'SYMFONY_ENV=${SYMFONY_ENV:-dev}'
      - 'XDEBUG_MODE=${XDEBUG_MODE_CLI:-off}'
    depends_on:
      database:
        condition: service_healthy
      search:
        condition: service_healthy
      mq:
        condition: service_healthy
      redis:
        condition: service_healthy
      mail:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 7G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  mail:
    image: ghcr.io/digitalspacestdio/orodc-mail
    build:
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/mail"
    container_name: ${DC_ORO_NAME:-unnamed}_mail
    hostname: mail.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - mail-certs:/certs
    ports:
      - "${DC_ORO_MAIL_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_MAIL_WEBGUI:-${DC_ORO_PORT_PREFIX}25}:8025"
    environment:
      - MP_SMTP_BIND_ADDR=0.0.0.0:1025
      - MP_SMTP_TLS_BIND_ADDR=:465
      - MP_SMTP_TLS_CERT=/certs/mail.crt
      - MP_SMTP_TLS_KEY=/certs/mail.key
      - MP_SMTP_AUTH_ACCEPT_ANY=1
      - MP_WEBROOT=/mailbox/
    restart: always
    networks:
      - default
      - dc_shared_net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dc_shared_net"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect.entrypoints=web"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect.rule=(${DC_ORO_TRAEFIK_RULE}) && Path(`/mailbox`)"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect.middlewares=${DC_ORO_NAME:-unnamed}-mail-redirect"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect.priority=300"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect-default.entrypoints=default"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect-default.rule=(${DC_ORO_TRAEFIK_RULE}) && Path(`/mailbox`)"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect-default.middlewares=${DC_ORO_NAME:-unnamed}-mail-redirect"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-redirect-default.priority=300"
      - "traefik.http.middlewares.${DC_ORO_NAME:-unnamed}-mail-redirect.redirectregex.regex=^https?://[^/]+/mailbox$$"
      - "traefik.http.middlewares.${DC_ORO_NAME:-unnamed}-mail-redirect.redirectregex.replacement=/mailbox/"
      - "traefik.http.middlewares.${DC_ORO_NAME:-unnamed}-mail-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail.entrypoints=web"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail.rule=(${DC_ORO_TRAEFIK_RULE}) && PathPrefix(`/mailbox/`)"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail.service=${DC_ORO_NAME:-unnamed}-mail"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail.priority=250"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-default.entrypoints=default"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-default.rule=(${DC_ORO_TRAEFIK_RULE}) && PathPrefix(`/mailbox/`)"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-default.service=${DC_ORO_NAME:-unnamed}-mail"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-mail-default.priority=250"
      - "traefik.http.services.${DC_ORO_NAME:-unnamed}-mail.loadbalancer.server.port=8025"
      - "traefik.http.services.${DC_ORO_NAME:-unnamed}-mail.loadbalancer.server.scheme=http"
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: "nc -vz -w 1 localhost 8025"
      start_period: 10s
      interval: 5s
      retries: 18

  xhgui:
    image: "xhgui/xhgui:0.18.4"
    hostname: xhgui.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    profiles: ["xhprof"]
    volumes:
      - "${DC_ORO_CONFIG_DIR:-.}/docker/xhgui/config:/var/www/xhgui/config"
      - "${DC_ORO_CONFIG_DIR:-.}/docker/xhgui/nginx.conf:/etc/nginx/conf.d/default.conf:ro"
    environment:
      - XHGUI_MONGO_HOSTNAME=mongodb
      - XHGUI_MONGO_DATABASE=xhprof
    ports:
      - "${DC_ORO_XHGUI_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_XHGUI:-80}:80"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: nc -vz -w 1 localhost 80
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  mongodb:
    image: percona/percona-server-mongodb:4.4
    hostname: mongodb.${DC_ORO_NAME:-unnamed}.docker.local
    container_name: ${DC_ORO_NAME:-unnamed}_mongodb
    dns:
      - 1.1.1.1
      - 8.8.8.8
    profiles: ["xhprof"]
    # (case sensitive) engine: mmapv1, rocksdb, wiredTiger, inMemory
    command: --storageEngine=wiredTiger
    environment:
      - MONGO_INITDB_DATABASE=xhprof
    volumes:
      - '${DC_ORO_CONFIG_DIR:-.}/docker/mongo/initdb.d:/docker-entrypoint-initdb.d'
    restart: always
    deploy:
      resources:
        limits:
          memory: 7G
    healthcheck:
      test: mongo --quiet --eval 'db.runCommand("ping").ok' xhgui
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  search:
    image: '${DC_ORO_ELASTICSEARCH_IMAGE:-elasticsearch}:${DC_ORO_ELASTICSEARCH_VERSION:-8.10.3}'
    hostname: search.${DC_ORO_NAME:-unnamed}.docker.local
    container_name: ${DC_ORO_NAME:-unnamed}_search
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - "search-data:/usr/share/elasticsearch/data:delegated"
    environment:
      ES_JAVA_OPTS: '${ES_JAVA_OPTS:--Xmx2048m}'
      cluster.name: 'search.${DC_ORO_NAME:-unnamed}.docker.local'
      discovery.type: 'single-node'
      bootstrap_memory_lock: 'false'
      xpack.security.enabled: 'false'
    ports:
      - "${DC_ORO_SEARCH_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_SEARCH:-9200}:9200"
    restart: always
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: /bin/bash -c "</dev/tcp/localhost/9200"
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  nginx:
    image: ghcr.io/digitalspacestdio/orodc-nginx
    hostname: nginx.${DC_ORO_NAME:-unnamed}.docker.local
    container_name: ${DC_ORO_NAME:-unnamed}_nginx
    dns:
      - 1.1.1.1
      - 8.8.8.8
    build:
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/nginx"
      args:
        APP_DIR: "${DC_ORO_APPDIR:-/var/www}"
    depends_on:
      fpm:
        condition: service_healthy
    ports:
      - '${DC_ORO_NGINX_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_NGINX:-80}:80'
    volumes:
      - "appcode:${DC_ORO_APPDIR:-/var/www}:ro"
    working_dir: "${DC_ORO_APPDIR:-/var/www}"
    networks:
      - 'dc_shared_net'
      - 'default'
    restart: always
    environment:
      - 'APP_DIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_APPDIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_PUBLIC_DIR=${DC_ORO_PUBLIC_DIR:-public}'
      - 'DC_ORO_NGINX_CONFIG=${DC_ORO_NGINX_CONFIG:-universal}'
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dc_shared_net"
      - "traefik.http.middlewares.compress-${DC_ORO_NAME:-unnamed}.compress=true"
      - "traefik.http.middlewares.cors-${DC_ORO_NAME:-unnamed}.headers.accessControlAllowCredentials=true"
      - "traefik.http.middlewares.cors-${DC_ORO_NAME:-unnamed}.headers.accessControlAllowHeaders=*"
      - "traefik.http.middlewares.cors-${DC_ORO_NAME:-unnamed}.headers.accessControlAllowMethods=PUT,GET,POST,HEAD,PATCH,DELETE"
      - "traefik.http.middlewares.cors-${DC_ORO_NAME:-unnamed}.headers.accessControlAllowOriginList=*"
      - "traefik.http.middlewares.resp-headers-${DC_ORO_NAME:-unnamed}.headers.customResponseHeaders.X-Project-Name=${DC_ORO_NAME:-unnamed}"
      - "traefik.http.middlewares.resp-headers-${DC_ORO_NAME:-unnamed}.headers.customResponseHeaders.X-Website-Code-Traefik=from-traefik"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}.entrypoints=web"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}.middlewares=compress-${DC_ORO_NAME:-unnamed},cors-${DC_ORO_NAME:-unnamed},resp-headers-${DC_ORO_NAME:-unnamed}"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}.rule=${DC_ORO_TRAEFIK_RULE}"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}.service=${DC_ORO_NAME:-unnamed}"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-default.entrypoints=default"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-default.middlewares=compress-${DC_ORO_NAME:-unnamed},cors-${DC_ORO_NAME:-unnamed},resp-headers-${DC_ORO_NAME:-unnamed}"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-default.rule=${DC_ORO_TRAEFIK_RULE}"
      - "traefik.http.routers.${DC_ORO_NAME:-unnamed}-default.service=${DC_ORO_NAME:-unnamed}"
      - "traefik.http.services.${DC_ORO_NAME:-unnamed}.loadbalancer.server.port=80"
      - "traefik.http.services.${DC_ORO_NAME:-unnamed}.loadbalancer.server.scheme=http"
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: /bin/bash -c "</dev/tcp/localhost/80"
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  mq:
    image: oroinc/rabbitmq:3.9-1-management-alpine
    hostname: mq.${DC_ORO_NAME:-unnamed}.docker.local
    container_name: ${DC_ORO_NAME:-unnamed}_mq
    dns:
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - "${DC_ORO_MQ_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_MQ:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${DC_ORO_MQ_USER:-app}
      RABBITMQ_DEFAULT_PASS: ${DC_ORO_MQ_PASSWORD:-app}
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: nc -vz -w 1 localhost 5672
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  redis:
    image: redis:6.2
    hostname: redis.${DC_ORO_NAME:-unnamed}.docker.local
    container_name: ${DC_ORO_NAME:-unnamed}_redis
    dns:
      - 1.1.1.1
      - 8.8.8.8
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: /bin/bash -c "</dev/tcp/localhost/6379"
      start_period: 5s
      interval: 5s
      retries: 18
    logging:
      driver: "json-file"
      options:
        max-size: "10m"

  ssh:
    container_name: "${DC_ORO_NAME:-unnamed}_ssh_${DC_ORO_PHP_VERSION:-8.4}-${DC_ORO_NODE_VERSION:-22}-${DC_ORO_COMPOSER_VERSION:-2}"
    hostname: ssh.${DC_ORO_NAME:-unnamed}.docker.local
    dns:
      - 1.1.1.1
      - 8.8.8.8
    build:
      dockerfile: Dockerfile.project
      context: "${DC_ORO_CONFIG_DIR:-.}/docker/project-php-node-symfony"
      args:
        BASE_IMAGE: "ghcr.io/digitalspacestdio/orodc-php-node-symfony:${DC_ORO_PHP_VERSION:-8.4}-node${DC_ORO_NODE_VERSION:-22}-composer${DC_ORO_COMPOSER_VERSION:-2}-${DC_ORO_PHP_DIST:-alpine}"
        APP_DIR: "${DC_ORO_APPDIR:-/var/www}"
        PHP_VERSION: "${DC_ORO_PHP_VERSION:-8.4}"
        NODE_VERSION: "${DC_ORO_NODE_VERSION:-22}"
        PHP_USER_NAME: "${DC_ORO_PHP_USER_NAME:-developer}"
        PHP_USER_GROUP: "${DC_ORO_PHP_USER_GROUP:-developer}"
        PHP_UID: "${DC_ORO_PHP_UID:-1000}"
        PHP_GID: "${DC_ORO_PHP_GID:-1000}"
        COMPOSER_VERSION: "${DC_ORO_COMPOSER_VERSION:-2}"
    tmpfs:
      - /tmp:rw,size=256m
    user: "root"
    command: docker-sshd
    volumes:
      - "appcode:${DC_ORO_APPDIR:-/var/www}"
      - "home-user:/home/${DC_ORO_PHP_USER_NAME:-developer}"
      - "home-root:/root"
      - "ssh-hostkeys:/etc/ssh/hostkeys"
      - "mail-certs:/certs:ro"
    working_dir: "${DC_ORO_APPDIR:-/var/www}"
    ports:
      - "${DC_ORO_SSH_BIND_HOST:-127.0.0.1}:${DC_ORO_PORT_SSH:-2222}:22"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    depends_on:
      database:
        condition: service_healthy
      search:
        condition: service_healthy
      mq:
        condition: service_healthy
      redis:
        condition: service_healthy
      mail:
        condition: service_healthy
    environment:
      - 'APP_DIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DC_ORO_APPDIR=${DC_ORO_APPDIR:-/var/www}'
      - 'DOCKER_BASE_URL=${DOCKER_BASE_URL:-https://${DC_ORO_NAME:-unnamed}.docker.local}'
      - 'DC_ORO_DATABASE_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'DC_ORO_DATABASE_PORT=${DC_ORO_DATABASE_PORT:-3306}'
      - 'DC_ORO_DATABASE_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'DC_ORO_DATABASE_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'DC_ORO_DATABASE_DBNAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_URL=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_DSN=${DC_ORO_DATABASE_URI:-"postgres://${DC_ORO_DATABASE_USER:-oro_db_user}:${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}@${DC_ORO_DATABASE_HOST:-database}:${DC_ORO_DATABASE_PORT:-5432}/${DC_ORO_DATABASE_DBNAME:-oro_db}"}'
      - 'ORO_DB_HOST=${DC_ORO_DATABASE_HOST:-database}'
      - 'ORO_DB_PORT=${DC_ORO_DATABASE_PORT:-5432}'
      - 'ORO_DB_NAME=${DC_ORO_DATABASE_DBNAME:-oro_db}'
      - 'ORO_DB_USER=${DC_ORO_DATABASE_USER:-oro_db_user}'
      - 'ORO_DB_PASSWORD=${DC_ORO_DATABASE_PASSWORD:-oro_db_pass}'
      - 'ORO_SEARCH_URL=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}'
      - 'ORO_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_search'
      - 'ORO_WEBSITE_SEARCH_ENGINE_DSN=${DC_ORO_SEARCH_URI:-elastic-search://search:9200}?prefix=oro_website_search'
      - 'ORO_MQ_DSN=${DC_ORO_MQ_URI:-""}'
      - 'ORO_REDIS_URL=${DC_ORO_REDIS_URI:-""}'
      - 'ORO_SESSION_DSN=${DC_ORO_REDIS_URI:-""}/0'
      - 'ORO_REDIS_CACHE_DSN=${DC_ORO_REDIS_URI:-""}/1'
      - 'ORO_REDIS_DOCTRINE_DSN=${DC_ORO_REDIS_URI:-""}/2'
      - 'ORO_REDIS_LAYOUT_DSN=${DC_ORO_REDIS_URI:-""}/3'
      - 'ORO_MAILER_DRIVER=${ORO_MAILER_DRIVER:-smtp}'
      - 'ORO_MAILER_HOST=${ORO_MAILER_HOST:-mail}'
      - 'ORO_MAILER_PORT=${ORO_MAILER_PORT:-1025}'
      - 'ORO_MAILER_ENCRYPTION=${ORO_MAILER_ENCRYPTION:-starttls}'
      - 'ORO_MAILER_USER=${ORO_MAILER_USER:-}'
      - 'ORO_MAILER_PASSWORD=${ORO_MAILER_PASSWORD:-}'
      - 'ORO_SECRET=${ORO_SECRET-ThisTokenIsNotSoSecretChangeIt}'
      - 'ORO_ENABLE_PRICE_SHARDING=${ORO_ENABLE_PRICE_SHARDING:-0}'
      - 'XHGUI_MONGO_HOSTNAME=mongodb'
      - 'XHGUI_MONGO_DATABASE=xhprof'
      - 'COMPOSER_AUTH=${DC_ORO_COMPOSER_AUTH}'
      - 'NODE_OPTIONS="--max-old-space-size=1024"'
      - 'SYMFONY_ENV=${SYMFONY_ENV:-dev}'
      - 'XDEBUG_MODE=${XDEBUG_MODE_CLI:-off}'
      - 'ORO_SSH_PUBLIC_KEY=${ORO_SSH_PUBLIC_KEY:-""}'
    restart: always
    deploy:
      resources:
        limits:
          memory: 7G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
    healthcheck:
      test: "nc -vz -w 1 localhost 22"
      start_period: 5s
      interval: 5s
      retries: 18

networks:
  dc_shared_net:
    external: true

volumes:
  appcode:
    external: true
    name: ${DC_ORO_NAME:-unnamed}_appcode
  ssh-hostkeys:
    driver: local
  home-user:
    driver: local
  home-root:
    driver: local
  search-data:
    driver: local
  mail-certs:
    driver: local
